Okay, Phase 2 will build upon the functional `quant` transform and core I/O from Phase 1. The focus will be on adding more sophisticated transforms (like `basis` for PCA/ICA-like decompositions and `embed` for applying them), enhancing validation, improving HDF5 robustness, and expanding API completeness.

---

# Milestone 2: Advanced Transforms & Robustness - Implementation Tickets

**Epic M2-E1: `basis` Transform Implementation (Dimensionality Reduction)**
*Goal: Implement a transform for learning and storing a basis set (e.g., PCA components).*

| #     | Ticket                                  | Description / Deliverables                                                                                                                                                                                                                                                                                                                                                                                                                                                        | Acceptance Criteria                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | Spec Refs    |
| :---- | :-------------------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :----------- |
| M2-1  | **`basis` Transform: Schema & Defaults**| Create `inst/schemas/basis.schema.json`. Define params (e.g., `method` \["pca", "ica", "nmf"], `k` \[components], `center` \[logical], `scale` \[logical], `solver_params` \[nested list for method-specific options], `storage_order` \["component_x_voxel", "voxel_x_component"]). <br> Ensure `lna:::default_params("basis")` works.                                                                                                                                           | • `basis.schema.json` is valid. <br> • `lna:::default_params("basis")` returns defaults. <br> • Parameter merging picks up defaults.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | §5, §7       |
| M2-2  | **`basis` Transform: S3 Forward**       | Implement `forward_step.basis(type, desc, handle)`: <br> • **Input:** `handle$stash$dense_mat` (or similar key for voxel x time data). <br> • **Logic:** Based on `desc$params$method` (start with "pca" via `irlba::prcomp_irlba` or `stats::prcomp`), compute basis matrix. Respect `k`, `center`, `scale`. <br> • **Output:** Store basis matrix (e.g., `/basis/transform_XX_name/matrix`) and any model metadata (e.g., mean, scale factors if centering/scaling done) as payloads. Update `desc` (paths, params, version). <br> • **Stash:** Put reference/indicator for basis (or nothing if next step is `embed` which reads from HDF5) into `handle$stash`. | • `write_lna` with `transforms=c("basis", ...)` stores basis matrix and model metadata. <br> • `desc` is correctly populated. <br> • Supports PCA method. <br> • Handles `center`, `scale`, `k`, and `storage_order` params. <br> • Data is correctly passed/consumed via stash.                                                                                                                                                                                                                                                                                                                                                                                       | §5           |
| M2-3  | **`basis` Transform: S3 Inverse**       | Implement `invert_step.basis(type, desc, handle)`: <br> • **Input:** This step reconstructs the "pre-basis" data. If `basis` is followed by `embed`, `invert_step.embed` would produce coefficients. `invert_step.basis` would then use these coefficients and its stored basis to reconstruct original data. <br> • **Logic:** If `basis` was the *last* data-mutating step (unlikely but possible), it might be a pass-through or error. More typically, it reconstructs `dense_mat = coefficients %*% basis_matrix_T` (or similar). <br> • **Output:** Reconstructed data (e.g., `dense_mat`) in `handle$stash`. <br> • Handle subsetting if applicable to coefficients/basis.     | • If `embed` is used, `invert_step.basis` correctly uses coefficients from `invert_step.embed` and its stored basis to reconstruct data. <br> • Fidelity of reconstruction is as expected for PCA. <br> • Subsetting on time (coefficients) and ROI (basis matrix, potentially complex) is applied correctly. <br> • Data is correctly passed/consumed via stash.                                                                                                                                                                                                                                                                                       | §5           |

**Epic M2-E2: `embed` Transform Implementation (Projection)**
*Goal: Implement a transform for applying a pre-computed basis to data.*

| #     | Ticket                                 | Description / Deliverables                                                                                                                                                                                                                                                                                                                                                                                                                                                      | Acceptance Criteria                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Spec Refs    |
| :---- | :------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :----------- |
| M2-4  | **`embed` Transform: Schema & Defaults** | Create `inst/schemas/embed.schema.json`. Define params (e.g., `basis_path` \[HDF5 path to basis matrix from a `basis` step], `center_data_with` \[path to mean vector or NULL], `scale_data_with` \[path to scale vector or NULL]). <br> Ensure `lna:::default_params("embed")` works.                                                                                                                                                                                                  | • `embed.schema.json` is valid. <br> • `lna:::default_params("embed")` returns defaults.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | §5, §7       |
| M2-5  | **`embed` Transform: S3 Forward**      | Implement `forward_step.embed(type, desc, handle)`: <br> • **Input:** `handle$stash$dense_mat`. <br> • **Logic:** Load basis matrix from `desc$params$basis_path`. Load centering/scaling vectors if specified. Apply (center)/scale to input data, then project onto basis: `coefficients = (data - mean) / scale %*% basis_matrix`. <br> • **Output:** Store coefficient matrix (e.g., `/scans/run-XX/transform_YY_name/coefficients`) as payload. Update `desc`. <br> • **Stash:** Put `coefficients` into `handle$stash` for next step (e.g., `quant`). | • `write_lna` with `transforms=c("basis", "embed", "quant")` writes basis, coefficients, and quantized coefficients. <br> • `embed` correctly loads basis/mean/scale from paths specified in its params. <br> • Coefficients are computed correctly. <br> • Data flow via stash is correct. <br> • `desc` is correctly populated.                                                                                                                                                                                                                                                                                                                                  | §5           |
| M2-6  | **`embed` Transform: S3 Inverse**      | Implement `invert_step.embed(type, desc, handle)`: <br> • **Input:** Reconstructed (e.g., de-quantized) coefficients from `handle$stash`. <br> • **Logic:** Load basis matrix from `desc$params$basis_path`. Load centering/scaling vectors. Reconstruct pre-projection data: `data_approx = coefficients %*% basis_matrix_T * scale + mean`. <br> • **Output:** `data_approx` (under a key like `reconstructed_from_embedding`) in `handle$stash` for `invert_step.basis`. <br> • Handle subsetting. | • `invert_step.embed` correctly reconstructs data using coefficients from previous inverse step and its stored basis/mean/scale. <br> • Subsetting (time on coefficients, ROI on basis) is applied. <br> • Data flow via stash is correct.                                                                                                                                                                                                                                                                                                                                                                                                                                                              | §5           |

**Epic M2-E3: HDF5 Robustness & Advanced I/O**
*Goal: Enhance HDF5 interaction for better performance and reliability.*

| #     | Ticket                                    | Description / Deliverables                                                                                                                                                                                                                                                                                                                                                                                                                        | Acceptance Criteria                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | Spec Refs    |
| :---- | :---------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :----------- |
| M2-7  | **Parallel Writing File Safety**          | Ensure `write_lna` (and internal docs) clearly advises on parallel writing: <br> • Multiple concurrent `write_lna` calls SHOULD use unique temporary filenames and `file.rename()` on success. <br> • Clarify that HDF5 'w' mode truncates. <br> • Add a test (conceptual or with temp files) demonstrating the atomic rename pattern.                                                                                                                      | • Documentation for `write_lna` includes the parallel writing note. <br> • Example/test case illustrates the recommended temp file + rename pattern.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | §9           |
| M2-8  | **HDF5 Retry Logic Refinement (Chunk)**   | Refine HDF5 write retry logic in `lna:::h5_write_dataset` / `materialise_plan`: <br> • Specifically for chunk size reduction: "first heuristic: target < 1 GiB; second heuristic if still fails: target <= 256 MiB". <br> • Ensure warnings are clear and informative.                                                                                                                                                                                   | • Unit tests specifically target scenarios where initial chunk sizes are too large (mocking HDF5 limits or errors), verifying that the two-stage reduction heuristic is applied. <br> • Warnings correctly indicate which heuristic was applied and the final chunk size.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | §2 (chunk_dims), §7 (materialise) |
| M2-9  | **Non-interactive Plugin Prompting**      | Implement non-interactive fallback for `allow_plugins="prompt"` in `core_read`: <br> • If `allow_plugins="prompt"` AND `!rlang::is_interactive()`, behave as if `allow_plugins="installed"`. <br> • (Actual interactive prompting can be deferred if complex, focusing on fallback).                                                                                                                                                              | • When `read_lna(allow_plugins="prompt")` is called in a non-interactive session (mock `rlang::is_interactive` to `FALSE`), it behaves like `"installed"`. <br> • (Future) If interactive: test prompt. For now, test fallback.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | §2 (allow_plugins) |
| M2-10 | **Fork-Safety for Schema Cache Doc/Test** | Address schema cache fork-safety: <br> • Add note to `validate_lna` documentation and/or general validation strategy section regarding potential fork-safety issues with compiled validators (e.g., from `jsonvalidate`) if using `future::plan(multicore)`. <br> • Suggest `lna:::schema_cache_clear()` in worker setup as a workaround. <br> • Add a test (if feasible with `future`) that demonstrates the issue or the workaround.                       | • Documentation includes the fork-safety note and workaround. <br> • (Optional, if testable) A test with `future` and multicore shows that validation might fail without cache clearing in workers, or succeeds with it.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | §6 (Schema Cache Note) |

**Epic M2-E4: API Completeness & Validation Enhancements**
*Goal: Flesh out remaining API elements and improve validation coverage.*

| #     | Ticket                                   | Description / Deliverables                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | Acceptance Criteria                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | Spec Refs    |
| :---- | :--------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :----------- |
| M2-11 | **`validate_lna`: Schema Validation Full** | Enhance `validate_lna` to robustly validate all transform descriptors found in `/transforms` against their respective schemas: <br> • Dynamically locate schemas (e.g., `inst/schemas/${type}.schema.json` or from a registered path if allowing external transform packages later). <br> • Use `jsonvalidate::json_validate`.                                                                                                                                                                                        | • `validate_lna` correctly finds and validates `basis.json` and `embed.json` descriptors against their schemas. <br> • Reports errors with specific reasons if validation fails. <br> • Handles missing schemas gracefully (warns if `strict=FALSE`, errors if `strict=TRUE`).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | §6           |
| M2-12 | **`validate_lna`: Strict Mode**            | Ensure `validate_lna(strict = TRUE/FALSE)` behavior is consistent: <br> • `strict=TRUE`: throws an error on first validation failure. <br> • `strict=FALSE`: collects all validation issues and returns `FALSE` (or a list of issues) if any exist, `TRUE` otherwise.                                                                                                                                                                                                                                               | • Unit tests verify that `strict=TRUE` stops and errors on failure. <br> • `strict=FALSE` continues, collects multiple errors (if present), and returns appropriate boolean/list.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | §2 (validate_lna) |
| M2-13 | **`write_lna`: `block_table` Handling**    | Implement `block_table` argument handling in `write_lna`: <br> • Accept data frame for `block_table`. <br> • Validate 1-based inclusive indices in masked voxel space (if mask provided). <br> • Write to `/spatial/block_table` as an HDF5 dataset (e.g., compound type or separate datasets per column).                                                                                                                                                                                                               | • `write_lna` with valid `block_table` DF writes it to `/spatial/block_table`. <br> • Validation of coordinates against mask's active voxel count works. <br> • Error if coordinates are out of 1-based masked voxel space range.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | §2 (block_table) |
| M2-14 | **`write_lna`: `plugins` Arg Stub**      | Add `plugins` argument to `write_lna` and `core_write`. <br> • For Phase 2, this can be a stub: accept a named list, serialize it to JSON, and write it to `/plugins/plugin_name.json`. <br> • No actual plugin execution logic yet.                                                                                                                                                                                                                                                                        | • `write_lna(plugins = list(myplugin = list(a=1)))` writes `/plugins/myplugin.json` containing `{"a":1}`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | §2 (plugins arg) |
| M2-15 | **`read_lna`: `run_id` Globbing**        | Implement `run_id` glob pattern matching in `core_read`: <br> • If `run_id` is a glob pattern (e.g., "run-\*"), identify matching run groups/descriptors in the LNA file. <br> • `read_lna` should then process/return data for all matched runs. (For P2, if `lazy=FALSE`, could return a list of results. If `lazy=TRUE`, `lna_reader` might need to handle multiple runs).                                                                                                                               | • `read_lna(file, run_id = "run-0*")` correctly identifies and processes runs "run-01", "run-02" but not "run-10". <br> • If `lazy=FALSE`, returns a list of reconstructed data for matched runs. <br> • (If `lazy=TRUE`, `lna_reader$print()` might list matched runs, and `$data()` might need a `run_id` arg or return list). This aspect needs careful design for `lna_reader`. Simplest for P2: `lazy=TRUE` with glob `run_id` might error or pick first match, deferring full multi-run lazy support. *Decision: For P2, `lazy=TRUE` with glob `run_id` will process the first matching run with a warning, or error if not well-defined.* | §2 (run_id arg) |
| M2-16 | **`read_lna`: `roi_mask` & `time_idx`**  | Fully integrate `roi_mask` and `time_idx` subsetting into `core_read` and transform `invert_step` methods: <br> • `core_read` populates `handle$subset` with these. <br> • `invert_step` methods (for `quant`, `basis`, `embed`) must check `handle$subset` and apply it during data reconstruction/loading. <br>    - `roi_mask`: subset voxels (can be complex for basis matrices). <br>    - `time_idx`: subset time points/coefficients.                 | • `read_lna` with `roi_mask` returns data only for specified voxels. <br> • `read_lna` with `time_idx` returns data only for specified time points. <br> • Both used together work. <br> • Subsetting is correctly applied by `quant`, `basis`, `embed` inverse steps. <br> • `lna_reader$data(roi_mask=..., time_idx=...)` also applies these correctly.                                                                                                                                                                                                                                                                                                    | §2 (roi_mask, time_idx), §5 |
| M2-17 | **Convenience Aliases**                | Implement `compress_fmri <- write_lna` and `open_lna <- read_lna`.                                                                                                                                                                                                                                                                                                                                                                                                                      | • `compress_fmri(...)` calls `write_lna(...)`. <br> • `open_lna(...)` calls `read_lna(...)`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | §2 (Aliases) |

**Epic M2-E5: Documentation & Testing**
*Goal: Comprehensive documentation for new features and robust testing, including multi-transform pipelines.*

| #     | Ticket                                      | Description / Deliverables                                                                                                                                                                                                                                                                                                                                                                                                                           | Acceptance Criteria                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | Spec Refs    |
| :---- | :------------------------------------------ | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :----------- |
| M2-18 | **Multi-Transform Integration Tests**       | Create integration tests for common transform pipelines: <br> • `basis` -> `embed` -> `quant` <br> • `quant` (direct) <br> • Test read/write consistency, subsetting, and `lna_reader` for these pipelines.                                                                                                                                                                                                                                                 | • End-to-end tests for specified pipelines pass: data written can be read back with expected fidelity. <br> • Subsetting and lazy reading work correctly across these pipelines.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | §8 (Testing) |
| M2-19 | **Cookbook Vignette Expansion**             | Expand "Cookbook" vignette: <br> • Example of using `basis` + `embed` + `quant` for PCA-based compression. <br> • Example of ROI/time slicing with `lna_reader` on a multi-transform file. <br> • Example of using `validate_lna`. <br> • Basic example of `scaffold_transform` and integrating a custom (stub) transform.                                                                                                                                           | • Cookbook vignette includes clear, runnable examples for all listed scenarios.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | §10          |
| M2-20 | **Documentation Update (Phase 2)**          | Update all relevant man pages, README, and other vignettes for features added in Phase 2: <br> • `basis` and `embed` transforms (params, behavior). <br> • `block_table`, `plugins` args. <br> • `run_id` globbing, full `roi_mask`/`time_idx` subsetting. <br> • Parallel writing safety notes. <br> • Fork-safety for schema cache.                                                                                                                                 | • All documentation accurately reflects Phase 2 functionality. <br> • Man pages for new/updated functions and transforms are complete.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | §10          |

---

**Milestone 2: Definition of Done**

*   The `lna` package can perform dimensionality reduction using a `basis` transform (initially PCA) followed by an `embed` transform, and can subsequently `quant` the coefficients.
*   The full pipeline (`basis` -> `embed` -> `quant`) is functional for writing and reading, including lazy reading and subsetting (`roi_mask`, `time_idx`).
*   HDF5 robustness is improved (chunk retry logic refined, parallel writing guidance).
*   `validate_lna` can perform full schema validation for implemented transforms.
*   Key API arguments (`block_table`, `plugins` stub, `run_id` globbing) are implemented.
*   Non-interactive fallback for plugin prompting and fork-safety considerations for schema cache are addressed.
*   Documentation, including the cookbook vignette, is significantly expanded to cover new transforms and features.
*   All Phase 2 tickets are complete, unit-tested, integration-tested, and CI passes.

---

This Phase 2 builds a much more capable LNA package, introducing core neuroimaging-relevant transforms and hardening the system. Phase 3 could then focus on more advanced transforms (temporal, delta, custom plugin system), further optimizations, and more comprehensive validation.