Okay, Phase 3 will focus on implementing more advanced transforms (temporal, delta), realizing the plugin system for custom extensions, significantly bolstering validation capabilities, and preparing for a feature-complete v1.0 release. We'll defer truly experimental or highly complex features (like full "stream" write mode or GPU acceleration) to Phase 4 or beyond, but lay groundwork where sensible.

---

# Milestone 3: Advanced Features & Pre-Release Polish - Implementation Tickets

**Epic M3-E1: Core Advanced Transforms (`temporal`, `delta`)**
*Goal: Implement core transforms for temporal processing and difference coding.*

| #     | Ticket                                   | Description / Deliverables                                                                                                                                                                                                                                                                                                                                                                                                                                                        | Acceptance Criteria                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | Spec Refs    |
| :---- | :--------------------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :----------- |
| M3-1  | **`temporal` Transform: Schema & Defaults**| Create `inst/schemas/temporal.schema.json`. Define params (`kind` \["dct", "bspline", "dpss", "polynomial"], `n_basis` or `order`, `knot_vector_path` or `knot_spacing_method` for bspline, `time_bandwidth_product` for dpss, `scope` \["global", "voxelwise"]). Ensure `lna:::default_params("temporal")` works.                                                                                                                                                             | • `temporal.schema.json` is valid. <br> • `lna:::default_params("temporal")` returns defaults. <br> • Parameter merging picks up defaults.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | §5, §7, Appx.#8 |
| M3-2  | **`temporal` Transform: S3 Methods (DCT)** | Implement `forward_step.temporal` and `invert_step.temporal` for `kind="dct"`: <br> • **Forward:** Generates DCT basis. Projects input data (e.g., `dense_mat` or `spatial_coefficients`) onto basis. Stores basis (if not standard/implicit) and coefficients. Updates `desc`, `stash`. <br> • **Inverse:** Loads basis (if stored) and coefficients. Reconstructs data. Handles subsetting (`time_idx` on coefficients). Updates `stash`.                                           | • `write_lna` with `transforms=c(..., "temporal", ...)` using `kind="dct"` stores DCT coefficients. <br> • `read_lna` reconstructs data with expected fidelity. <br> • Handles different `n_basis`. <br> • Subsetting on time works correctly.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | §5, Appx.#8   |
| M3-3  | **`temporal` Transform: S3 Methods (B-spline)** | Extend `temporal` S3 methods for `kind="bspline"`: <br> • **Forward:** Generates/loads B-spline basis (from `knot_vector_path` or auto-generated knots). Projects data. Stores basis/knots (if explicit) and coefficients. <br> • **Inverse:** Reconstructs using B-spline basis.                                                                                                                                                                                          | • `write_lna` with `kind="bspline"` (using specified or auto knots) stores B-spline coefficients and basis/knot info. <br> • `read_lna` reconstructs. <br> • Manages knot definition and storage.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | §5, Appx.#8   |
| M3-4  | **`delta` Transform: Schema & Defaults**   | Create `inst/schemas/delta.schema.json`. Define params (`order`, `axis`, `reference_value_storage` ["first_value_verbatim", "reconstruct_from_deltas"], `coding_method` ["none", "rle", "range_coded" - focus on "none" and "rle" for P3]). Ensure `lna:::default_params("delta")` works.
| M3-5  | **`delta` Transform: S3 Methods**          | Implement `forward_step.delta` and `invert_step.delta`: <br> • **Forward:** Computes deltas along `axis`. Stores first value(s) if `reference_value_storage="first_value_verbatim"`. Stores (optionally RLE coded) deltas. Updates `desc`, `stash`. <br> • **Inverse:** Loads first value(s) and deltas. Reconstructs original series. Handles RLE decoding. Handles subsetting. Updates `stash`.                                                                        | • `write_lna` with `transforms=c(..., "delta", ...)` stores first value and delta stream. <br> • `read_lna` reconstructs data correctly. <br> • Supports `order=1`. <br> • RLE coding/decoding works if `coding_method="rle"`. <br> • Handles `reference_value_storage` options. <br> • Subsetting (e.g., on time) correctly reconstructs partial series.                                                                                                                                                                                                                                                                                                                                                         | §5, Appx.#5   |

**Epic M3-E2: Basic Plugin System & Custom Transform Infrastructure**
*Goal: Enable users to integrate their own transforms, starting with the `myorg.sparsepca` example.*

| #     | Ticket                                         | Description / Deliverables                                                                                                                                                                                                                                                                                                                                                                                                                                                        | Acceptance Criteria                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | Spec Refs    |
| :---- | :--------------------------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :----------- |
| M3-6  | **Plugin Transform Discovery & Registration**  | Mechanism for LNA to discover S3 methods for transforms not in the core `lna` package: <br> • Relies on S3 method dispatch working across packages (standard R behavior). <br> • `core_write`/`core_read` will call `forward_step`/`invert_step` which R dispatches. <br> • `lna:::default_params` needs to find schemas from other packages (e.g., via a convention like `system.file("inst/schemas", package="otherPkg")` or a registration system if more complex). For P3, convention is fine. | • `write_lna(transforms="myorg.sparsepca", ...)` successfully calls `forward_step.myorg.sparsepca` from a separate (test) package. <br> • `lna:::default_params("myorg.sparsepca")` can find and load `myorg.sparsepca.schema.json` from the test package's `inst/schemas`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | §2 (transforms), §5, §7, Recipe |
| M3-7  | **Implement `myorg.sparsepca` Example**        | Fully implement `myorg.sparsepca` (as per recipe card and addendum) in a separate example package or within `lna` tests/examples: <br> • `inst/schemas/myorg.sparsepca.schema.json`. <br> • `R/transform_sparsepca.R` with `forward_step` and `invert_step`. <br> • Dependencies (e.g., `irlba`, `Matrix`). <br> • Handles sparse matrix storage (e.g., separate datasets for data, indices, indptr for CSC).                                                                       | • `myorg.sparsepca` can be used in `write_lna` and `read_lna`. <br> • Basis matrix is stored in a sparse HDF5 representation and correctly reconstructed. <br> • Parameters (`k`, `alpha`, `storage_order`) are handled. <br> • Works correctly as a standalone transform or after `myorg.aggregate_runs`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | Recipe, Appx.#9 |
| M3-8  | **Implement `myorg.aggregate_runs` Example**   | Fully implement `myorg.aggregate_runs` (as per recipe card and addendum) in example/test package: <br> • `inst/schemas/myorg.aggregate_runs.schema.json`. <br> • `R/transform_aggregate.R` with `forward_step` and `invert_step`. <br> • Handles `method = "concatenate_time"`. <br> • Correctly interacts with stash (`initial_input_list` -> `aggregated_matrix_for_encoder`).                                                                                                   | • `myorg.aggregate_runs` can be used as the first transform with a list input to `write_lna`. <br> • Correctly aggregates data for subsequent encoder (e.g., `myorg.sparsepca`). <br> • `runs_included` param is recorded. <br> • `invert_step` passes through reconstructed aggregated data.             

see Appendix1.md                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | Recipe, Appx.#10 |
| M3-9  | **`write_lna`: `plugins` Arg Implementation**  | Fully implement `plugins` argument in `write_lna` and `materialise_plan`: <br> • Accepts named list. Each element is a plugin's parameters. <br> • For each plugin `pname` in `plugins`: <br>   1. Serialize `plugins[[pname]]` to JSON. <br>   2. Write to `/plugins/${pname}/params.json`. <br>   3. (Optional for P3) Store plugin version if discoverable.                                                                                                                  | • `write_lna(plugins = list(mypluginA = list(opt=1), mypluginB = list(val="x")))` creates `/plugins/mypluginA/params.json` and `/plugins/mypluginB/params.json` with correct content. <br> • `read_lna` can access these (e.g. via `handle$h5$open_group("/plugins")`).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | §2 (plugins) |
| M3-10 | **`read_lna`: `allow_plugins` Full Impl.**     | Fully implement `allow_plugins` in `core_read`: <br> • `"installed"` (default): Load/use transform if S3 methods available (package installed). <br> • `"prompt"`: Ask interactively. If `!is_interactive()`, fallback to "installed". (Interactive part can be simple `utils::menu` or `readline`). <br> • `"none"`: Skip optional transforms requiring external packages (how to identify "optional requiring external"? TBD, for P3: assume all custom transforms are such, error if method not found). | • `allow_plugins="installed"` works with `myorg.sparsepca`. <br> • `allow_plugins="none"` with `myorg.sparsepca` in `transforms` list in file: if `myorg.sparsepca` is not essential for data integrity (e.g. just an encoding), it might skip or error. If essential (like `quant`), it must load or error. *Refinement: "none" means don't *attempt* to load S3 methods for types not in core LNA. If a file *requires* such a transform, it will fail at S3 dispatch.* <br> • `allow_plugins="prompt"` (interactive) prompts user; (non-interactive) falls back to "installed". | §2 (allow_plugins) |

**Epic M3-E3: Comprehensive Validation & File Integrity**
*Goal: Implement robust validation routines and ensure file integrity mechanisms are complete.*

| #     | Ticket                                   | Description / Deliverables                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | Acceptance Criteria                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | Spec Refs    |
| :---- | :--------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :----------- |
| M3-11 | **`validate_lna`: Full Structure Check**   | Enhance `validate_lna` to check for expected core HDF5 groups/attributes: <br> • Presence of `/`, `/transforms`, `/basis`, `/scans`, `/spatial` (if block_table used), `/plugins` (if plugins arg used). <br> • Root attributes: `lna_spec`, `creator`, `required_transforms`. <br> • Coherence of `plan$datasets` paths with actual HDF5 datasets. <br> • `write_mode_effective` consistency.                                                                                                                | • `validate_lna` identifies missing core groups/attributes. <br> • Checks paths in `plan$datasets` in transform descriptors against HDF5 file structure. <br> • Returns detailed error/warning messages.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | §6           |
| M3-12 | **`validate_lna`: Data Integrity Hints**   | Add (optional, advanced) checks in `validate_lna` for basic data integrity hints (not full reconstruction): <br> • Dataset dimensions in descriptors match HDF5 dataset dimensions. <br> • Stored `dtype` in descriptors (if any) matches HDF5 dataset types. <br> • (Very basic) Check for all-zero or all-NaN datasets if unexpected.                                                                                                                                                                               | • `validate_lna` warns about dimension/dtype mismatches between descriptors and HDF5 datasets. <br> • Can optionally flag suspicious (all-zero/NaN) datasets.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | §6           |
| M3-13 | **Runtime Validation in `core_read`**      | Implement `validate=TRUE` option in `read_lna`/`core_read`: <br> • Performs basic runtime validation during processing (e.g., does dataset from descriptor exist before trying to read it?). <br> • Checks if `transform_params` stored in descriptor are compatible with the S3 method being called (e.g., all required params present).                                                                                                                                                                       | • `read_lna(..., validate=TRUE)` catches missing datasets referenced by descriptors. <br> • Warns/errors if a transform's `invert_step` is called with incompatible/missing parameters from the stored descriptor.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | §2 (validate arg), §6 |
| M3-14 | **Error Reporting: Step Provenance**     | Ensure `rlang::abort(..., location = ...)` uses `step_index` / transform name consistently: <br> • All `forward_step` and `invert_step` methods should wrap critical operations with error handlers that add this context. <br> • `materialise_plan` errors should also clearly indicate which dataset/descriptor caused the issue.                                                                                                                                                                               | • Errors thrown during `write_lna` or `read_lna` transform loops clearly identify the failing transform name and its index in the sequence.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | §6           |

**Epic M3-E4: API Polish, Documentation & Final Preparations**
*Goal: Complete API details, ensure comprehensive documentation, and prepare for a v1.0 candidate.*

| #     | Ticket                                      | Description / Deliverables                                                                                                                                                                                                                                                                                                                                                                                                                           | Acceptance Criteria                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | Spec Refs    |
| :---- | :------------------------------------------ | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :----------- |
| M3-15 | **`lna_options()` Full Implementation**     | Ensure `lna_options()` can get/set all relevant global defaults: <br> • e.g., `write.compression_level`, `write.chunk_target_mib`, default params for core transforms if applicable (e.g., `quant.bits`, `delta.order`). <br> • Ensure deep merging logic for `transform_params` in `write_lna` correctly uses these package-level defaults.                                                                                                                  | • `lna_options()` can set and retrieve all specified global options. <br> • `write_lna` uses these global options as the second layer in parameter merging.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | §2 (lna_options), §2 (transform_params) |
| M3-16 | **Testing: Complex Pipelines & Edge Cases** | Add more extensive integration tests: <br> • Chains involving `temporal`, `delta`, `myorg.sparsepca`, `myorg.aggregate_runs`. <br> • Edge cases: empty input data, single voxel/timepoint data, files with no transforms. <br> • Test interactions with `lna_reader` (subsetting, caching) for these complex pipelines. <br> • Test checksum validation for various file sizes/modifications.                                                                                     | • All defined complex pipelines (write -> read -> validate) pass. <br> • Edge case tests run without unexpected errors and produce valid (even if empty) LNA files/results. <br> • `lna_reader` functions correctly with these files.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | §8           |
| M3-17 | **Cookbook Vignette: Advanced Usage**       | Expand "Cookbook" vignette further: <br> • Example using `temporal` transform. <br> • Example using `delta` transform (e.g., after `quant`). <br> • Detailed example of creating and using `myorg.sparsepca` and `myorg.aggregate_runs` from scratch (using `scaffold_transform`). <br> • How to interpret `validate_lna` output.                                                                                                                                   | • Cookbook includes clear, runnable examples for all new advanced features. <br> • Custom transform example is comprehensive.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | §10          |
| M3-18 | **Full API Documentation Review (roxygen)** | Conduct a thorough review of all exported functions' roxygen2 documentation: <br> • Ensure all parameters, return values, and examples are clear, correct, and complete. <br> • Cross-reference related functions. <br> • Ensure consistency in style and terminology. <br> • Generate and review full PDF manual.                                                                                                                                                         | • All man pages are accurate, complete, and well-formatted. <br> • Examples are runnable and illustrative. <br> • PDF manual is clean.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | §10          |
| M3-19 | **`NEWS.md` and Versioning for v1.0**     | Prepare `NEWS.md` detailing changes from initial development through Phase 3. <br> • Decide on versioning for the first "feature-complete" release (e.g., v0.9.0 if P4 is bugfixes for v1.0, or v1.0.0-rc1). For now, aim for readiness for a `v1.0.0` candidate.                                                                                                                                                                                              | • `NEWS.md` is comprehensive. <br> • Package version in `DESCRIPTION` is updated appropriately (e.g., to `0.9.0` or `1.0.0-dev`).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | -            |
| M3-20 | **Website/`pkgdown` Site**                | Generate and polish a `pkgdown` website for the package. <br> • Ensure all vignettes, references, and news are correctly rendered. <br> • Customize theme/layout if desired.                                                                                                                                                                                                                                                                                         | • `pkgdown` site builds cleanly. <br> • Content is well-organized and accessible. <br> • Key documentation (README, vignettes, function reference) is easily navigable.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | -            |

---

**Milestone 3: Definition of Done**

*   Core advanced transforms (`temporal` with DCT/B-spline, `delta` with RLE) are implemented and functional.
*   A basic plugin system is operational, demonstrated by the successful integration and use of `myorg.sparsepca` and `myorg.aggregate_runs` example transforms.
*   `validate_lna` is significantly enhanced, performing comprehensive structure checks and basic data integrity hints. Runtime validation is active in `read_lna`.
*   Error reporting consistently includes step provenance.
*   API details (`lna_options`, `plugins` arg, `allow_plugins`) are fully implemented.
*   Documentation (roxygen, vignettes, `NEWS.md`, `pkgdown` site) is comprehensive and polished, reflecting all features up to Phase 3.
*   Extensive testing, including complex transform pipelines and edge cases, passes.
*   The package is considered feature-complete according to the v1.4 specification and ready for consideration as a v1.0 release candidate (pending Phase 4 bug fixing and final polish).
*   All Phase 3 tickets are complete, unit-tested, integration-tested, and CI passes.

---

Phase 4 would then be:
*   Bug fixing based on extensive P3 testing and any release candidate feedback.
*   Performance profiling and optimization of critical paths.
*   Final review of spec compliance.
*   (Optional) Implementation of any "nice-to-have" small features or further robustness measures deferred from P1-P3.
*   Finalizing all documentation for v1.0.0 release.
*   Potentially exploring more advanced HDF5 filters (Blosc, Zstd) if time allows and deemed critical for v1.0.