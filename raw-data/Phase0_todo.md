# Milestone 0: Container & Core Skeleton - Implementation Tickets


** check off completed tickets when finished **

| #     | Ticket                        | Status      | Notes                                                                                      |
|-------|-------------------------------|-------------|--------------------------------------------------------------------------------------------|
| M0-1  | **Initial Project Scaffold**  | [x]         | Project skeleton, imports, and testthat setup are present.                                 |
| M0-2  | **Plan R6 Class**             | [ ]         | Not present. Implement `Plan` R6 class and methods.                                        |
| M0-3  | **DataHandle R6 Class**       | [ ]         | Not present. Implement `DataHandle` R6 class and methods.                                  |
| M0-4  | **JSON Helpers**              | [x]         | `read_json_descriptor`/`write_json_descriptor` implemented and tested.                     |
| M0-5  | **HDF5 Attribute Helpers**    | [x]         | Attribute helpers implemented and tested.                                                  |
| M0-6  | **Transform Discovery**       | [x]         | `discover_transforms` implemented and fully tested.                                        |
| M0-7  | **S3 Generics**               | [ ]         | Not present. Implement `forward_step`/`invert_step` generics and default methods.          |
| M0-8  | **Core Write Skeleton**       | [ ]         | Not present. Implement `core_write` structure.                                             |
| M0-9  | **Core Read Skeleton**        | [ ]         | Not present. Implement `core_read` structure.                                              |
| M0-10 | **`materialise_plan` Stub**   | [x]         | Implement `lna:::materialise_plan` stub (R/materialise.R):<br>• Accepts an open HDF5 file object (e.g., from `H5File$new(path, mode="w")`) and a `Plan` R6 object.<br>• Creates core HDF5 groups: `/transforms`, `/basis`, `/scans`.<br>• Writes root-level attributes to `/` using HDF5 attribute helpers (M0-5):<br>  &nbsp;&nbsp;- `lna_spec` (character string, e.g., "LNA R v2.0")<br>  &nbsp;&nbsp;- `creator` (character string, e.g., "lna R package v0.0.1")<br>  &nbsp;&nbsp;- `required_transforms` (e.g., initially `character(0)` or an empty list).<br>• Iterates through `plan$descriptors` (a list of descriptor lists):<br>  &nbsp;&nbsp;- For each, calls `lna:::write_json_descriptor(h5_group = h5_file[["/transforms"]], name = <name_from_plan>, desc_list = <content_from_plan>)`.<br>• Iterates through `plan$datasets` (tibble):<br>  &nbsp;&nbsp;- Sets `write_mode_effective` to `"eager"` for all entries in the `Plan` object.<br>• **Does NOT write any numeric data payloads.**<br>• Operates on the provided HDF5 file object; does not handle file opening/closing or checksums. |
| M0-11 | **Public API Wrappers**       | [ ]         | Not present. Implement `write_lna`, `read_lna`.                                            |
| M0-12 | **Error Classes & Utilities** | [ ]         | Partial: Some error handling present, but no centralized error classes or `abort_lna` helper. |
| M0-13 | **CI & Code Style**           | [ ]         | Unknown: Not assessable from current files. Ensure CI and linting are set up.              |
| M0-14 | **Options & Defaults Stubs**  | [x]         | Not present. Implement `lna_options()` and `default_params()`.                             |
| M0-15 | **Schema Cache Stub**         | [ ]         | Not present. Implement `schema_cache_clear()`.                                             |

---

**Milestone 0: Definition of Done** (Original content below, for reference)

*   The `lna` package builds and passes `R CMD check --as-cran` cleanly.
*   `write_lna()` produces a structurally valid HDF5 file containing root attributes, core groups (`/transforms`, `/basis`, `/scans`), and transform JSON descriptors (as per plan). Numeric payloads are **not** written yet.
*   `read_lna()` can open the file created by `write_lna()`, discover the transform list, execute the (noop) inverse transform loop without error, and close the file handle reliably.
*   Core classes (`Plan`, `DataHandle`), basic HDF5/JSON/Attribute helpers, parameter handling stubs, and error infrastructure are implemented and unit-tested.
*   CI pipeline is established and passes.

---
Original Epic Description (for reference)

**Epic M0-E1: Core Container & Contract Infrastructure**
*Goal: Establish an executable package skeleton with core classes, helpers, and API stubs, capable of writing/reading descriptor-only LNA files. No domain-specific transform logic.*

### Detailed Tickets (Original Table)

| #     | Ticket                        | Description / Deliverables                                                                                                                                                                                                                                                                                                                                                                                    | Acceptance Criteria                                                                                                                                                                                                                          | Spec Refs    |
| :---- | :---------------------------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :----------- |
| M0-1  | **Initial Project Scaffold**  | • Create `lna` package skeleton (`R/`, `NAMESPACE`, `DESCRIPTION`, `inst/`, `tests/`). <br> • Add `Imports`: `hdf5r`, `jsonlite`, `Matrix`, `rlang`, `tibble`, `progressr`, `digest`, `jsonvalidate`, `withr`. <br> • Setup `testthat`.                                                                                                                                                                       | `devtools::check()` passes with zero R code errors/warnings.                                                                                                                                                                                  | §8 (Pkg)     |
| M0-2  | **`Plan` R6 Class**         | Implement `Plan` (R/plan.R). <br> • **Fields:** `datasets` (tibble), `descriptors` (list), `payloads` (list), `next_index` (int). <br> • **Methods:** `initialize`, `add_payload`, `add_dataset_def` (incl. `write_mode`), `add_descriptor`, `get_next_filename`, `mark_payload_written`.                                                                                                   | • Unit tests verify all methods. <br> • `add_descriptor` increments index, formats name correctly. <br> • `add_dataset_def` row contains all columns incl. `write_mode`. <br> • `mark_payload_written` sets `payloads[[key]]` to `NULL`. <br> • `get_next_filename()` is monotonic ("00_", "01_", ...). | §4 (Pkg)     |
| M0-3  | **`DataHandle` R6 Class**   | Implement `DataHandle` (R/handle.R). <br> • **Fields:** `stash`, `meta`, `plan`, `h5`, `subset`. <br> • **Methods:** `initialize`, `get_inputs`, `update_stash`, `with`, `exists`.                                                                                                                                                                                                                          | • `update_stash` returns new object (`h1` unchanged after `h2 <- h1$update_stash(...)`, checked via `identical(names(h1), names(h2))` and `!identical(h1, h2)`). <br> • `get_inputs` raises `"lna_error_contract"` on missing key. <br> • `exists` works. | §4 (Pkg)     |
| M0-4  | **JSON Helpers**            | Implement (R/utils_json.R): <br> • `lna:::read_json_descriptor(h5_group, name)` <br> • `lna:::write_json_descriptor(h5_group, name, desc_list)` using H5T_C_S1 (variable-length, null-terminated UTF-8). <br> • Ensure `write_json_descriptor` is idempotent (overwrites existing).                                                                                                                               | • Object → `write` → `read` → Object round-trip yields identical object. <br> • HDF5 dataset type is correct. <br> • Writing to existing path replaces content without error.                                                                      | §7 (Pkg), §2 (Spec) |
| M0-5  | **HDF5 Attribute Helpers**  | Implement (R/utils_hdf5.R): <br> • `lna:::h5_attr_write(h5_obj, name, value)` <br> • `lna:::h5_attr_read(h5_obj, name)` <br> • `lna:::h5_attr_exists(h5_obj, name)` <br> • `lna:::h5_attr_delete(h5_obj, name)`                                                                                                                                                                                          | • Write/Read round-trip for various R types. <br> • `h5_attr_exists` works. <br> • `h5_attr_delete` removes attribute.                                                                                                                         | §7 (Pkg)     |
| M0-6  | **Transform Discovery**     | Implement `lna:::discover_transforms(h5_group)` → tibble(`name`, `type`, `index`). <br> • Handles empty `/transforms` group. <br> • Ensures `NN_` is 00, 01,... contiguous.                                                                                                                                                                                                                          | • Unit test with dummy HDF5 files (correct sequence, missing sequence, non-numeric prefix, empty group). <br> • Empty `/transforms` returns 0-row tibble. <br> • Raises `"lna_error_sequence"` on non-contiguous index.                             | §7 (Pkg), §3.3 (Spec) |
| M0-7  | **S3 Generics**             | Add `forward_step(type, desc, handle)` and `invert_step(type, desc, handle)` generics with default methods that call `lna:::abort_lna(..., .subclass="lna_error_no_method")`. (R/dispatch.R)                                                                                                                                                                                        | `methods("forward_step")` lists default; calling default method throws expected error.                                                                                                                                                  | §3 (Pkg)     |
| M0-8  | **Core Write Skeleton**     | Implement `lna:::core_write` structure (R/core_write.R): <br> • Accept `x`, `transforms`, `transform_params`. <br> • **Stub:** Derive initial `mask`/`header`. <br> • Create initial `DataHandle`. <br> • **Stub:** Merge `transform_params` with defaults (uses M0-14). <br> • Loop calling `forward_step`. <br> • Return `list(handle, plan)`.                                                              | • Unit test with mock `forward_step` confirms loop structure and param merging stub call. <br> • Plan accumulates N descriptors.                                                                                                          | §3, §2 (Pkg) |
| M0-9  | **Core Read Skeleton**      | Implement `lna:::core_read` structure (R/core_read.R): <br> • Open file, `on.exit(h5$close_all())`. <br> • Create initial `DataHandle`. <br> • Call `discover_transforms`. <br> • **Stub:** Handle `allow_plugins`, `validate` args. <br> • Loop (reverse) calling `invert_step`. <br> • Close HDF5 file via `on.exit`. <br> • Return `handle`.                                                                    | • Unit test with empty `/transforms` group reads ok. <br> • File handle is closed even if default `invert_step` errors during loop (check via mock).                                                                                 | §3, §2 (Pkg) |
| M0-10 | **`materialise_plan` Stub** | [x]         | Implement `lna:::materialise_plan` stub (R/materialise.R):<br>• Accepts an open HDF5 file object (e.g., from `H5File$new(path, mode="w")`) and a `Plan` R6 object.<br>• Creates core HDF5 groups: `/transforms`, `/basis`, `/scans`.<br>• Writes root-level attributes to `/` using HDF5 attribute helpers (M0-5):<br>  &nbsp;&nbsp;- `lna_spec` (character string, e.g., "LNA R v2.0")<br>  &nbsp;&nbsp;- `creator` (character string, e.g., "lna R package v0.0.1")<br>  &nbsp;&nbsp;- `required_transforms` (e.g., initially `character(0)` or an empty list).<br>• Iterates through `plan$descriptors` (a list of descriptor lists):<br>  &nbsp;&nbsp;- For each, calls `lna:::write_json_descriptor(h5_group = h5_file[["/transforms"]], name = <name_from_plan>, desc_list = <content_from_plan>)`.<br>• Iterates through `plan$datasets` (tibble):<br>  &nbsp;&nbsp;- Sets `write_mode_effective` to `"eager"` for all entries in the `Plan` object.<br>• **Does NOT write any numeric data payloads.**<br>• Operates on the provided HDF5 file object; does not handle file opening/closing or checksums. |
| M0-11 | **Public API Wrappers**     | Implement `write_lna`, `read_lna` (R/api.R) calling core functions. <br> • Forward parameters correctly. <br> • `write_lna` calls `materialise_plan` stub. <br> • `write_lna` adds `class = "lna_write_result"` to return list.                                                                                                | • `write_lna(..., file=NULL)` runs, returns list with `plan` & `class`. <br> • `read_lna()` on that path runs without error (returning empty handle). <br> • Parameter pass-through verified.                                                              | §2 (Pkg)     |
| M0-12 | **Error Classes & Utilities** | Define base error classes (`lna_error_sequence`, `lna_error_contract`, `lna_error_io`, `lna_error_validation` stub, `lna_error_no_method`) using `rlang::abort`. Create `lna:::abort_lna(...)` helper. (R/utils_error.R) | • Tests trigger each defined M0 error class via mocks or invalid inputs.                                                                                 | §6 (Pkg)     |
| M0-13 | **CI & Code Style**         | Add GitHub Actions workflow: <br> • `R CMD check --as-cran` on Linux, macOS, Windows (release, devel). <br> • Integrate `lintr::lint_package()` check (fail build if lints found). <br> • Optionally integrate `styler`.                                                                                                 | • CI workflow runs and passes on push/PR for M0 codebase.                                                                                                    | —            |
| M0-14 | **Options & Defaults Stubs** | Implement `lna_options()` using package environment (R/options.R). Implement `lna:::default_params(type)` stub returning `list()` and basic caching (R/utils_defaults.R).                                | • Unit test: set/get options via `lna_options()`. <br> • `lna:::default_params("foo")` returns `list()` and subsequent call is cached.                                                                                              | §2, §7 (Pkg) |
| M0-15 | **Schema Cache Stub**       | Implement `lna:::schema_cache_clear()` setting a private env/list to empty. (R/utils_json.R or separate file).                                                                                   | Unit test: call `clear`, check cache object is empty.                                                                                                     | §7 (Pkg)     |

---

**Milestone 0: Definition of Done**

*   The `lna` package builds and passes `R CMD check --as-cran` cleanly.
*   `write_lna()` produces a structurally valid HDF5 file containing root attributes, core groups (`/transforms`, `/basis`, `/scans`), and transform JSON descriptors (as per plan). Numeric payloads are **not** written yet.
*   `read_lna()` can open the file created by `write_lna()`, discover the transform list, execute the (noop) inverse transform loop without error, and close the file handle reliably.
*   Core classes (`Plan`, `DataHandle`), basic HDF5/JSON/Attribute helpers, parameter handling stubs, and error infrastructure are implemented and unit-tested.
*   CI pipeline is established and passes.

---

This detailed M0 plan provides a solid, verifiable foundation for the subsequent implementation phases.