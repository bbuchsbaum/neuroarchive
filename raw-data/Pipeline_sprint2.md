Okay, here are the granular tickets for **Sprint 2** of implementing the LNA Tidy Pipeline DSL. This sprint builds upon the foundation of Sprint 1, focusing on enhancing the `lna_pipeline` object with introspection and modification capabilities, implementing the template system, verb registration for extensions, and adding more core DSL verbs, including context-aware ones.

**Assumptions for Sprint 2:**
*   Sprint 1 deliverables are complete and stable: `lna_pipeline` R6 class with basic methods, `as_pipeline()`, `lna_write()`, and a few simple verbs with parameter merging are functional.
*   Core LNA engine remains stable.

---

# LNA Tidy Pipeline DSL - Sprint 2 Implementation Tickets

**Epic DSL-S2-E1: Enhanced `lna_pipeline` Object Capabilities**
*Goal: Make the `lna_pipeline` object more interactive, inspectable, and modifiable by users.*

| #        | Ticket                                                   | Description / Deliverables                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | Acceptance Criteria                                                                                                                                                                                                                                                                                                                                                                                                | Appendix Ref          |
| :------- | :------------------------------------------------------- | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :-------------------- |
| DSL-S2-1 | **`lna_pipeline$print()` Method**                        | • Implement a user-friendly `$print()` method for `lna_pipeline`. <br> • Output should include: <br>   - Input data summary (from `self$input_summary`). <br>   - Number of steps. <br>   - For each step: index, type, and key parameters (user-supplied parameters highlighted, defaults styled subtly using `pillar::style_subtle()` or similar).                                                                                                                                                             | • Calling `print(pipeline_obj)` or just `pipeline_obj` at the console displays a clear, informative summary. <br> • Distinguishes user-set vs. default parameters visually if feasible.                                                                                                                                                                                                                            | §3.1, Micro-tip 3     |
| DSL-S2-2 | **`lna_pipeline` Introspection Methods**                 | • Implement `$steps()`: returns the raw list of step specifications. <br> • Implement `$get_step(index_or_type)`: retrieves step by 1-based `index` or by `type` string (returns the *last* matching step if type is duplicated). <br> • Implement `$get_last_step_spec()`: returns the specification of the most recently added step.                                                                                                                                                                      | • `$steps()` returns the internal list of steps. <br> • `$get_step()` correctly retrieves steps by index or type string. <br> • `$get_last_step_spec()` works as expected.                                                                                                                                                                                                                                            | §3.1, §2.1 (Context)  |
| DSL-S2-3 | **`lna_pipeline` Modification Methods (Core)**           | • Implement `$modify_step(index_or_type, new_params_list)`: <br>   - Finds step by `index_or_type` (last match for type). <br>   - Merges `new_params_list` with the existing `step$params` (potentially re-running full 3-stage merge for that step to respect defaults if `new_params_list` unsets something). <br> • Implement `$remove_step(index_or_type)`: Removes step by index or type (last match). <br> • Implement `$insert_step(step_spec, after_index_or_type = NULL, before_index_or_type = NULL)`. | • `$modify_step()` correctly updates parameters of a specified step; subsequent `$print()` reflects changes. <br> • `$remove_step()` correctly removes a step. <br> • `$insert_step()` correctly inserts a new step at specified position. <br> • Indices of subsequent steps are updated after removal/insertion if necessary for `$get_step(index)`. | §3.1                  |
| DSL-S2-4 | **`lna_pipeline$validate_params()` Method**              | • Implement `$validate_params(strict = FALSE)`. <br> • For each step in `self$steps`: <br>   - Retrieve schema for `step$type`. <br>   - Validate `step$params` against the schema (e.g., using `jsonvalidate::json_validate` after `jsonlite::toJSON(step$params, auto_unbox=TRUE)`). <br>   - Collect all validation failures. <br> • If `strict=FALSE` (default), issues warnings for failures and returns list of failures (or `TRUE` if all valid). <br> • If `strict=TRUE`, aborts on first failure. | • `$validate_params()` correctly identifies valid and invalid parameters against schemas. <br> • `strict=FALSE` collects all errors and warns. <br> • `strict=TRUE` aborts on first error.                                                                                                                                                                                                              | §3.1, Micro-tip 4     |
| DSL-S2-5 | **`lna_pipeline$diagram()` Method (Text & DOT)**         | • Implement `$diagram(engine = c("grViz", "ascii", "dot"))`. <br> • Generates a DOT language string representing the linear pipeline (Input -> Step 1 -> Step 2 -> ... -> Output). <br> • Node labels include step index, type, and a compact summary of key parameters. <br> • If `engine="dot"`, returns DOT string. <br> • If `engine="grViz"` (and `DiagrammeR` installed), calls `DiagrammeR::grViz()`. <br> • If `engine="ascii"` (and `DiagrammeRsvg`, `asciiSVG` installed), generates ASCII art. | • `$diagram("dot")` returns a valid DOT string. <br> • `$diagram("ascii")` produces readable text art. <br> • `$diagram()` attempts `grViz` and falls back gracefully if `DiagrammeR` is not available. <br> • Parameter text in ASCII diagram is clipped for readability.                                                                                                                             | §2.2                  |
| DSL-S2-6 | **Unit Tests for Enhanced Pipeline Methods**           | • Tests for `$print()` (capture output, check key elements). <br> • Tests for `$steps()`, `$get_step()`, `$get_last_step_spec()`. <br> • Tests for `$modify_step()`, `$remove_step()`, `$insert_step()`, including effects on step list and indices. <br> • Tests for `$validate_params()` with valid/invalid params, strict TRUE/FALSE. <br> • Tests for `$diagram()` for DOT output and ASCII output (mocking `DiagrammeR` if needed for CI).         | • All unit tests pass. <br> • Pipeline introspection and modification methods behave as specified.                                                                                                                                                                                                                                                                                                           | -                     |

**Epic DSL-S2-E2: Verb Implementation & Extensibility**
*Goal: Implement remaining core DSL verbs, context-aware verbs, and the registration mechanism for external verbs and templates.*

| #        | Ticket                                                        | Description / Deliverables                                                                                                                                                                                                                                                                                                                                                                                                                                                          | Acceptance Criteria                                                                                                                                                                                                                                                                                                                                                                                                   | Appendix Ref                  |
| :------- | :------------------------------------------------------------ | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :---------------------------- |
| DSL-S2-7 | **Implement Remaining Core DSL Verbs (delta, temporal, hrbf)**| • Implement `delta(data_or_pipe, ...)`, `temporal(data_or_pipe, ...)`, `hrbf(data_or_pipe, ...)`. <br> • Each verb follows the pattern from Sprint 1 (internal `as_pipeline`, 3-stage parameter merge, `$add_step`). <br> • Maps to LNA transform types `delta`, `temporal`, `spat.hrbf` respectively. <br> • Export verbs.                                                                                                                                                    | • `delta()`, `temporal()`, `hrbf()` verbs correctly add steps with resolved parameters. <br> • Pipelines using these verbs can be written with `lna_write()`.                                                                                                                                                                                                                                              | §3.3, §3.5                    |
| DSL-S2-8 | **Implement Context-Aware `embed()` Verb**                    | • Implement `embed(data_or_pipe, ...)` verb. <br> • Calls `pipeline_obj$get_last_step_spec()`. <br> • If `prev_step$type` is "basis.pca" or "spat.hrbf" (or other known basis producers): <br>   - Auto-populates `params$basis_path` based on conventional HDF5 path for the output of `prev_step` (e.g., using `prev_step$descriptor_basename`). <br>   - Sets LNA transform type to e.g., "embed.pca" or "embed.hrbf_analytic". <br> • Else, aborts or uses a generic "embed" type if one exists. | • `data |> as_pipeline() |> pca(k=10) |> embed()` correctly configures the embed step. <br> • Works similarly after `hrbf()`. <br> • Errors gracefully if `embed()` is called after an incompatible transform.                                                                                                                                                                                                | §2.1 (Context-aware)        |
| DSL-S2-9 | **Verb Registration System (`register_lna_verb`)**            | • Create `R/dsl_registry.R` (or similar). <br> • Implement `register_lna_verb(verb_name, lna_transform_type, default_slug = TRUE, force = FALSE)`. <br>   - `verb_name` can be a string or symbol. If string, it becomes the function name. <br>   - If `default_slug=TRUE` and `verb_name` is NULL, slug `lna_transform_type` (e.g., `my.org.filt` -> `my_org_filt`) to create `verb_name`. <br>   - Stores mapping in a package-internal environment (verb registry). <br>   - Warns on collision unless `force=TRUE`. | • External packages can call `register_lna_verb()` in their `.onLoad()` to make DSL verbs available. <br> • Default slugging and collision handling work. <br> • The DSL uses this registry (how? TBD - verbs are top-level functions. Registry might be more for discovery/listing or for a generic `pipeline_obj$verb(...)` call). *Clarification: Registry is mainly for bookkeeping, help systems, and potential future metaprogramming. Verbs are still defined as standard R functions.* | Q_DSL-1 Answer, Micro-tip 2,7 |
| DSL-S2-10| **Pipeline Template System (`register_lna_template`, `apply_template`)** | • Implement `register_lna_template(template_name, template_function)`. <br>   - `template_function` takes `(pipeline_obj, ...)` and returns a modified `pipeline_obj`. <br>   - Stores mapping in a template registry. <br> • Implement `apply_template(pipeline_obj, template_name, ...)` verb. <br>   - Retrieves `template_function`. <br>   - Calls `updated_pipe <- template_function(pipeline_obj, ...)` (passing `...` to the template function for its internal logic). <br>   - Further processes `...` for overrides (e.g., `pca.k=120` becomes `$modify_step("basis.pca", list(k=120))`). | • Users can define and register pipeline templates. <br> • `data |> as_pipeline() |> apply_template("my_std", pca.k=50)` works, applying the template and then overriding `pca.k`. <br> • Override logic handles dotted names and nested lists.                                                                                                                                           | §3 (Templates), Micro-tip 5 |
| DSL-S2-11| **Unit Tests for Verbs, Context-Awareness, Registration, Templates** | • Tests for `delta()`, `temporal()`, `hrbf()` verbs (parameter merging, pipeline execution). <br> • Tests for context-aware `embed()` with various preceding steps. <br> • Tests for `register_lna_verb()` (registration, slugging, collision). <br> • Tests for `register_lna_template()` and `apply_template()` (template application, parameter overriding).                                                                                     | • All unit tests pass. <br> • Core DSL functionality is robust and extensible.                                                                                                                                                                                                                                                                                                                           | -                             |

---

**Sprint 2 - Definition of Done:**

*   The `lna_pipeline` R6 object has comprehensive methods for introspection (`$print`, `$steps`, `$get_step`), modification (`$modify_step`, `$remove_step`, `$insert_step`), schema validation (`$validate_params`), and visualization (`$diagram`).
*   All core LNA transforms (quant, pca/basis, embed, delta, temporal, hrbf) have corresponding DSL verbs with correct parameter merging.
*   At least one context-aware verb (e.g., `embed()`) is implemented and functional.
*   The systems for registering external DSL verbs (`register_lna_verb`) and pipeline templates (`register_lna_template`, `apply_template`) are implemented and tested.
*   Unit tests cover all new `lna_pipeline` methods, new verbs, context-awareness, registration, and template functionalities.
*   The DSL significantly improves the ergonomics of defining LNA transform pipelines.

This sprint makes the DSL feature-rich and ready for broader internal testing and documentation. The "micro-tips" regarding `pillar` styling, `memoise`, etc., should be incorporated throughout the implementation of these tickets.